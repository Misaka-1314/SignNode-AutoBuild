name: 构建并推送基础 Docker 镜像

on:
  schedule:
    - cron: "0 17 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  docker-image:
    runs-on: ubuntu-latest

    steps:
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 缓存 Docker 构建层
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ github.sha }}

      - name: 登录 Docker Hub 容器镜像服务
        uses: docker/login-action@v3
        with:
          username: misaka1314
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: 获取文件
        run: |
          wget -O "Dockerfile" "https://raw.githubusercontent.com/Misaka-1314/SignNode-AutoBuild/main/resource/base.Dockerfile"
          wget -O "requirements.txt" "https://raw.githubusercontent.com/Misaka-1314/SignNode-AutoBuild/main/resource/base.requirements.txt"

      - name: 获取当前日期作为版本号
        id: date
        run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: 构建镜像
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            misaka1314/waadri-base:latest
            misaka1314/waadri-base:v${{ steps.date.outputs.date }}
          labels: |
            image.source=WAADRI-Base
            image.author=github.com/Misaka
          platforms: linux/amd64,linux/arm64
